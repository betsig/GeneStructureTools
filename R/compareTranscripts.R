#' Evaluate changes to ORFs caused by alternative splicing
#' @param orfsX orf information for 'normal' transcripts. Generated by getOrfs()
#' @param orfsY orf information for 'alternative' transcripts. Generated by getOrfs()
#' @param filterNMD filter orf information for transcripts not targeted by nmd first?
#' @param geneSimilarity compare orf to all orfs in gene?
#' @param compareUTR compare UTRs?
#' @param compareBy compare by 'transcript' isoforms or by 'gene' groups
#' @return data.frame with orf changes
#' @export
#' @import stringr
#' @examples
#' @author Beth Signal
orfDiff <- function(orfsX,
                    orfsY,
                    filterNMD = TRUE,
                    geneSimilarity = TRUE,
                    compareUTR = TRUE,
                    compareBy="gene",
                    ORF_db=NULL){
    if(filterNMD == TRUE){
        orfChanges <- attrChangeAltSpliced(orfsX[which(orfsX$nmd_prob < 0.5),],
                                            orfsY[which(orfsY$nmd_prob < 0.5),],
                                            attribute = "orf_length",
                                            compareBy = compareBy,
                                           useMax = TRUE,
                                           compareUTR = compareUTR)

        orfChanges.filterx <- attrChangeAltSpliced(orfsX[which(orfsX$nmd_prob < 0.5),],
                                                    orfsY,
                                                    attribute = "orf_length",
                                                   compareBy = compareBy,
                                                   useMax = TRUE,
                                                   compareUTR = compareUTR)
        orfChanges.filtery <- attrChangeAltSpliced(orfsX,
                                                    orfsY[which(orfsY$nmd_prob < 0.5),],
                                                    attribute = "orf_length",
                                                   compareBy = compareBy,
                                                   useMax = TRUE,
                                                   compareUTR = compareUTR)

        orfChanges.nofilter <- attrChangeAltSpliced(orfsX,
                                                     orfsY,
                                                     attribute = "orf_length",
                                                    compareBy = compareBy,
                                                    useMax = TRUE,
                                                    compareUTR = compareUTR)

        if(nrow(orfChanges) > 0){
            orfChanges$filtered <- "both"
        }
        if(nrow(orfChanges.filterx) > 0){
            orfChanges.filterx$filtered <- "x"
        }
        if(nrow(orfChanges.filtery) > 0){
            orfChanges.filtery$filtered <- "y"
        }
        if(nrow(orfChanges.nofilter) > 0){
            orfChanges.nofilter$filtered <- "none"
        }
        add <- which(!(orfChanges.filterx$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.filterx[add,])
        add <- which(!(orfChanges.filtery$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.filtery[add,])
        add <- which(!(orfChanges.nofilter$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.nofilter[add,])

    }else{
        orfChanges <- attrChangeAltSpliced(orfsX,orfsY,attribute = "orf_length",
                                            compareBy=compareBy,useMax = TRUE,
                                           compareUTR = compareUTR)
        orfChanges$filtered <- FALSE
    }


    orfsY$transcript_id <- unlist(lapply(str_split(orfsY$id, "[+]"),"[[", 1))
    if(compareBy == "gene"){
        orfsY$spliced_id <- unlist(lapply(str_split(orfsY$id, "AS "),"[[", 2))
    }else{
        orfsY$spliced_id <- orfsY$id
    }

    orfChanges$transcript_id <- orfsY$transcript_id[match(orfChanges$id, orfsY$spliced_id)]
    orfChanges$gene_id <- orfsY$gene_id[match(orfChanges$id, orfsY$spliced_id)]

    orfsY$id_with_len <- paste0(orfsY$spliced_id, "_", orfsY$orf_length)
    orfChanges$id_orf_length_y <- paste0(orfChanges$id, "_",orfChanges$orf_length_bygroup_y)

    my <- match(orfChanges$id_orf_length_y, orfsY$id_with_len)

    if(all(!grepl("AS ", orfsX$id))){
        orfsX$id_with_len <- paste0(orfsX$gene_id, "_", orfsX$orf_length)
        orfChanges$id_orf_length_x <- paste0(orfChanges$gene_id, "_",orfChanges$orf_length_bygroup_x)
    }else{
        if(compareBy == "gene"){
            orfsX$spliced_id <- unlist(lapply(str_split(orfsX$id, "AS "),"[[", 2))
        }else{
            orfsX$spliced_id <- orfsX$id
        }
        orfsX$id_with_len <- paste0(orfsX$spliced_id, "_", orfsX$orf_length)
        orfChanges$id_orf_length_x <- paste0(orfChanges$id, "_",orfChanges$orf_length_bygroup_x)
    }

    mx <- match(orfChanges$id_orf_length_x, orfsX$id_with_len)

    x <- as.numeric(mapply(function(x,y) orfSimilarity(x,y),
                           orfsX$orf_sequence[mx][run],
                           orfsY$orf_sequence[my][run]))

    orfChanges$percent_orf_shared <- x

    max_len <- apply(orfChanges[,c('orf_length_bygroup_y','orf_length_bygroup_x')], 1, max)

    orfChanges$max_percent_orf_shared <- (max_len - abs(orfChanges$orf_length_bygroup_x - orfChanges$orf_length_bygroup_y)) /
        max_len

    orfLengthShared <- orfChanges$percent_orf_shared * max_len

    orfChanges$orf_percent_kept_x <- orfLengthShared / orfChanges$orf_length_bygroup_x
    orfChanges$orf_percent_kept_y <- orfLengthShared / orfChanges$orf_length_bygroup_y


    if(geneSimilarity == TRUE & !is.null(ORF_db)){


        gene_matches <- lapply(orfChanges$gene_id, function(x) which(!is.na(match(ORF_db$gene_id, x))))
        gene_matches <- unlist(gene_matches)

        id_matches <- mapply(function(x,y) rep(x,length(y)) ,(1:length(orfChanges$gene_id)), gene_matches)

        #gene_matches <- lapply(orfChanges$gene_id, function(x) which(!is.na(match(orfsX$gene_id, x))))
        #id_matches <- mapply(function(x,y) rep(x,length(y)) ,(1:length(orfChanges$gene_id)), gene_matches)

        id_matches_y  <- match(orfChanges$id_orf_length_y[id_matches], orfsY$id_with_len)
        id_matches_x  <- match(orfChanges$id_orf_length_x[id_matches], orfsX$id_with_len)

        x.bygene_y <- as.numeric(mapply(function(x,y) orfSimilarity(x,y),
                                      ORF_db$orf_sequence[gene_matches],
                                      orfsY$orf_sequence[id_matches_y]))

        x.bygene_x <- as.numeric(mapply(function(x,y) orfSimilarity(x,y),
                                        ORF_db$orf_sequence[gene_matches],
                                        orfsX$orf_sequence[id_matches_x]))

        orfSimilarity.bygene <- data.frame(gene_id=ORF_db$gene_id[gene_matches],
                                           spliced_id_x=orfsX$spliced_id[id_matches_x],
                                           spliced_id_y=orfsY$spliced_id[id_matches_y],
                                           similarity_x=x.bygene_x,
                                           similarity_y=x.bygene_y,
                                           length_gene=ORF_db$orf_length[gene_matches],
                                           length_x=orfsX$orf_length[id_matches_x],
                                           length_y=orfsY$orf_length[id_matches_y])

        # orfLengthKept <- orfSimilarity.bygene$similarity * orfSimilarity.bygene$length_x
        # orfSimilarity.bygene$orf_percent_new <- 1 - orfLengthKept / orfSimilarity.bygene$length_y
        #
        # orfSimilarity.bygeneAgg <- aggregate(similarity ~ spliced_id, orfSimilarity.bygene, max)
        # m <- match(orfChanges$id, orfSimilarity.bygeneAgg$spliced_id)
        # orfChanges$max_orf_similarity_bygene <- orfSimilarity.bygeneAgg$similarity[m]
        #
        # orfNew.bygeneAgg <- aggregate(orf_percent_new ~ spliced_id, orfSimilarity.bygene, min)
        # m <- match(orfChanges$id, orfNew.bygeneAgg$spliced_id)
        # orfChanges$new_orfBygene <- orfNew.bygeneAgg$orf_percent_new[m]

        orfSimilarity.bygeneAggX <- aggregate(similarity_x ~ spliced_id_x, orfSimilarity.bygene, max)
        orfSimilarity.bygeneAggY <- aggregate(similarity_y ~ spliced_id_y, orfSimilarity.bygene, max)

        orfChanges$gene_similarity_x <- orfSimilarity.bygeneAggX$similarity_x[match(orfChanges$id, orfSimilarity.bygeneAggX$spliced_id_x)]
        orfChanges$gene_similarity_y <- orfSimilarity.bygeneAggY$similarity_y[match(orfChanges$id, orfSimilarity.bygeneAggY$spliced_id_y)]

    }

    orfChanges$transcript_id <- NULL
    orfChanges$gene_id <- NULL
    orfChanges$id_orf_length_x <- NULL
    orfChanges$id_orf_length_y <- NULL

    return(orfChanges)
}

#' Evaluate the change in an attribute between a set of 'normal' transcripts and 'alternative' transcripts
#' @param orfsX orf information for 'normal' transcripts. Generated by getOrfs()
#' @param orfsY orf information for 'alternative' transcripts. Generated by getOrfs()
#' @param attribute attribute to compare
#' @param compareBy compare by 'transcript' isoforms or by 'gene' groups
#' @param useMax use max as the summary function when multiple isoforms are aggregated? If FALSE, will use min instead.
#' @return data.frame with attribute changes
#' @export
#' @import stringr
#' @examples
#' @author Beth Signal
attrChangeAltSpliced <- function(orfsX,
                                 orfsY,
                                 attribute = "orf_length",
                                 compareBy = "gene",
                                 useMax = TRUE,
                                 compareUTR = FALSE){

    if(nrow(orfsX) > 0 & nrow(orfsY) > 0){

        if(useMax){
            aggFun <- max
        }else{
            aggFun <- min
        }

        m <- match(c('id','gene_id', attribute), colnames(orfsX))

        orfsX.part <- orfsX[,m]

        attributeX <- aggregate(. ~ id+gene_id, orfsX.part, aggFun)

        if(all(grepl("AS", attributeX$id))){
            attributeX$as_group <- unlist(lapply(str_split(attributeX$id, " "), '[[', 2))
            attributeX$transcript_id <- unlist(lapply(str_split(attributeX$id, "[+]"), '[[', 1))
        }

        m <- match(c('id','gene_id', attribute), colnames(orfsY))
        orfsY.part <- orfsY[,m]
        attributeY <- aggregate(. ~ id+gene_id, orfsY.part, aggFun)

        if(all(grepl("AS", attributeY$id))){
            attributeY$as_group <- unlist(lapply(str_split(attributeY$id, " "), '[[', 2))
            attributeY$transcript_id <- unlist(lapply(str_split(attributeY$id, "[+]"), '[[', 1))
        }


        if(all(colnames(attributeX) != "as_group")){
            m <- match(attributeY$transcript_id, attributeX$id)
            attributeX <- attributeX[m,]
            attributeX$as_group <- attributeY$as_group
            attributeX$id <- attributeY$id
        }else if(all(colnames(attributeY) != "as_group")){
            m <- match(attributeX$transcript_id, attributeY$id)
            attributeY <- attributeY[m,]
            attributeY$as_group <- attributeX$as_group
            attributeY$id <- attributeX$id
        }

        colnames(attributeX)[3] <- "attr"
        colnames(attributeY)[3] <- "attr"

        if(compareBy == "transcript"){
            m <- match(attributeX$id, attributeY$id)
            attributeComparisons <- data.frame(id=attributeX$id,
                                     attr_bygroup_x=attributeX$attr,
                                     attr_bygroup_y=attributeY$attr[m])

            m <- match(attributeY$id, attributeX$id)
            attributeComparisonsY <- data.frame(id=attributeY$id,
                                       attr_bygroup_x=attributeX$attr[m],
                                       attr_bygroup_y=attributeY$attr)

            add <- which(!(attributeComparisonsY$id %in% attributeComparisons$id))

            if(length(add) > 0){
                attributeComparisons <- rbind(attributeComparisons, attributeComparisonsY[add,])
            }
        }else if(compareBy=="gene"){
            attributeX2 <- aggregate(attr ~ as_group, attributeX, aggFun)
            attributeY2 <- aggregate(attr ~ as_group, attributeY, aggFun)

            m <- match(attributeX2$as_group, attributeY2$as_group)
            attributeComparisons <- data.frame(id=attributeX2[,1],
                                     attr_bygroup_x=attributeX2[,-1],
                                     attr_bygroup_y=attributeY2[m,-1])
            attributeComparisons <- attributeComparisons[which(!is.na(m)),]

        }
        colnames(attributeComparisons) <- gsub("attr", attribute, colnames(attributeComparisons))

        if(compareUTR == TRUE & attribute == "orf_length"){
            if(all(grepl("AS", orfsX$id))){
                id_x <- paste0(attributeComparisons$id,"_" ,attributeComparisons$orf_length_bygroup_x)
                if(compareBy == "gene"){
                    m1 <- match(id_x, paste0(unlist(lapply(str_split(orfsX$id, "AS "), "[[", 2)), "_", orfsX$orf_length))
                }else{
                    m1 <- match(id_x, paste0(orfsX$id, "_", orfsX$orf_length))
                }
            }else{
                m_toGene <- match(attributeComparisons$id, attributeX$as_group)
                id_x <- paste0(unlist(lapply(str_split(attributeX$id[m_toGene], "[+]"),"[[",1)),"_" ,attributeComparisons$orf_length_bygroup_x)
                m1 <- match(id_x, paste0((orfsX$id), "_", orfsX$orf_length))
            }
            id_y <- paste0(attributeComparisons$id,"_" ,attributeComparisons$orf_length_bygroup_y)
            if(compareBy == "gene"){
                m2 <- match(id_y, paste0(unlist(lapply(str_split(orfsY$id, "AS "), "[[", 2)), "_", orfsY$orf_length))
            }else{
                m2 <- match(id_y, paste0(orfsY$id, "_", orfsY$orf_length))
            }

            attributeComparisons$utr3_length_bygroup_x <- orfsX$utr3_length[m1]
            attributeComparisons$utr3_length_bygroup_y <- orfsY$utr3_length[m2]
            attributeComparisons$utr5_length_bygroup_x <- orfsX$start_site_nt[m1]
            attributeComparisons$utr5_length_bygroup_y <- orfsY$start_site_nt[m2]
        }

        return(attributeComparisons)
    }else{
        blank <- data.frame(id=character(0),
                            attr_bygroup_x=numeric(0),
                            attr_bygroup_y=numeric(0))
        colnames(blank) <- gsub("attr", attribute, colnames(blank))
        if(compareUTR == TRUE){
            blank$utr3_length_bygroup_x <- numeric(0)
            blank$utr3_length_bygroup_y <- numeric(0)
            blank$utr5_length_bygroup_x <- numeric(0)
            blank$utr5_length_bygroup_y <- numeric(0)
        }
        return(blank)
    }
}
#' calculate percentage of orfB contained in orfA
#' @param orfA character string of ORF amino acid sequence
#' @param orfB character string of ORF amino acid sequence
#' @return percentage of orfB contained in orfA
#' @export
#' @import stringdist
#' @import qualV
#' @import stringr
#' @examples
#' @author Beth Signal
orfSimilarity <- function(orfA, orfB, return="percent"){
    if(is.na(orfA) | is.na(orfB)){
        return(NA)
    }else{

        #lcs <- stringdist::stringdist(orfA ,orfB, method = "lcs")
        #lcs <- qualV::LCS(unlist(stringr::str_split(orfA,"")),unlist(stringr::str_split(orfB,"")))
        #return(lcs$QSI)
        #alternatively...
        if(nchar(orfA) > nchar(orfB)){
            lcs <- adist(orfA, orfB, costs=list(ins=100, del=1, sub=100))[1,1]
        }else{
            lcs <- adist(orfA, orfB, costs=list(ins=1, del=100, sub=100))[1,1]
        }

        if(lcs <= nchar(orfA) + nchar(orfB)){
            return(((nchar(orfA) + nchar(orfB) - lcs)/2) / max(nchar(orfA), nchar(orfB)))
        }else{
            return(0)
        }
    }
}
