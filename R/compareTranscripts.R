#' Evaluate changes to ORFs caused by alternative splicing
#' @param orfsX orf information for 'normal' transcripts. Generated by getOrfs()
#' @param orfsY orf information for 'alternative' transcripts. Generated by getOrfs()
#' @param filterNMD filter orf information for transcripts not targeted by nmd first?
#' @param geneSimilarity compare orf to all orfs in gene?
#' @return data.frame with orf changes
#' @export
#' @import stringr
#' @examples
#' @author Beth Signal
orfDiff <- function(orfsX,
                    orfsY,
                    filterNMD = TRUE,
                    geneSimilarity = TRUE,
                    compareUTR = FALSE){
    if(filterNMD == TRUE){
        orfChanges <- attrChangeAltSpliced(orfsX[orfsX$nmd_prob < 0.5,],
                                            orfsY[orfsY$nmd_prob < 0.5,],
                                            attribute = "orf_length",
                                            compareBy="gene",useMax = TRUE,
                                           compareUTR = compareUTR)

        orfChanges.filterx <- attrChangeAltSpliced(orfsX[orfsX$nmd_prob < 0.5,],
                                                    orfsY,
                                                    attribute = "orf_length",
                                                    compareBy="gene",useMax = TRUE,
                                                   compareUTR = compareUTR)

        orfChanges.filtery <- attrChangeAltSpliced(orfsX,
                                                    orfsY[orfsY$nmd_prob < 0.5,],
                                                    attribute = "orf_length",
                                                    compareBy="gene",useMax = TRUE,
                                                   compareUTR = compareUTR)

        orfChanges.nofilter <- attrChangeAltSpliced(orfsX,
                                                     orfsY,
                                                     attribute = "orf_length",
                                                     compareBy="gene",useMax = TRUE,
                                                    compareUTR = compareUTR)

        if(nrow(orfChanges) > 0){
            orfChanges$filtered <- "both"
        }
        if(nrow(orfChanges.filterx) > 0){
            orfChanges.filterx$filtered <- "x"
        }
        if(nrow(orfChanges.filtery) > 0){
            orfChanges.filtery$filtered <- "y"
        }
        if(nrow(orfChanges.nofilter) > 0){
            orfChanges.nofilter$filtered <- "none"
        }
        add <- which(!(orfChanges.filterx$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.filterx[add,])
        add <- which(!(orfChanges.filtery$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.filtery[add,])
        add <- which(!(orfChanges.nofilter$id %in% orfChanges$id))
        orfChanges <- rbind(orfChanges, orfChanges.nofilter[add,])

    }else{
        orfChanges <- attrChangeAltSpliced(orfsX,orfsY,attribute = "orf_length",
                                            compareBy="gene",useMax = TRUE,
                                           compareUTR = compareUTR)
        orfChanges$filtered <- FALSE
    }


    orfsY$transcript_id <- unlist(lapply(str_split(orfsY$id, "[+]"),"[[", 1))
    orfsY$spliced_id <- unlist(lapply(str_split(orfsY$id, "AS "),"[[", 2))
    orfChanges$transcript_id <- orfsY$transcript_id[match(orfChanges$id, orfsY$spliced_id)]
    orfChanges$gene_id <- orfsY$gene_id[match(orfChanges$id, orfsY$spliced_id)]

    orfsY$id_with_len <- paste0(orfsY$spliced_id, "_", orfsY$orf_length)
    orfChanges$id_orf_length_y <- paste0(orfChanges$id, "_",orfChanges$orf_length_bygroup_y)

    my <- match(orfChanges$id_orf_length_y, orfsY$id_with_len)

    if(all(!grepl("AS ", orfsX$id))){
        orfsX$id_with_len <- paste0(orfsX$gene_id, "_", orfsX$orf_length)
        orfChanges$id_orf_length_x <- paste0(orfChanges$gene_id, "_",orfChanges$orf_length_bygroup_x)
    }else{
        orfsX$spliced_id <- unlist(lapply(str_split(orfsX$id, "AS "),"[[", 2))
        orfsX$id_with_len <- paste0(orfsX$spliced_id, "_", orfsX$orf_length)
        orfChanges$id_orf_length_x <- paste0(orfChanges$id, "_",orfChanges$orf_length_bygroup_x)
    }

    mx <- match(orfChanges$id_orf_length_x, orfsX$id_with_len)

    x <- as.numeric(mapply(function(x,y) orfSimilarity(x,y),
                           orfsX$orf_sequence[mx],
                           orfsY$orf_sequence[my]))

    orfChanges$percent_orf_kept <- x

    orfChanges$max_percent_orf_kept <- orfChanges$orf_length_bygroup_y /
        orfChanges$orf_length_bygroup_x
    orfChanges$max_percent_orf_kept[orfChanges$max_percent_orf_kept > 1] <- 1

    orfLengthKept <- orfChanges$percent_orf_kept * orfChanges$orf_length_bygroup_x
    orfChanges$orf_percent_new <- 1 - orfLengthKept / orfChanges$orf_length_bygroup_y

    if(geneSimilarity == TRUE){
        gene_matches <- lapply(orfChanges$gene_id, function(x) which(!is.na(match(orfsX$gene_id, x))))
        id_matches <- mapply(function(x,y) rep(x,length(y)) ,(1:length(orfChanges$gene_id)), gene_matches)

        gene_matches <- unlist(gene_matches)
        id_matches  <- unlist(id_matches)
        id_matches  <- match(orfChanges$id_orf_length_y[id_matches], orfsY$id_with_len)

        x.bygene <- as.numeric(mapply(function(x,y) orfSimilarity(x,y),
                                      orfsX$orf_sequence[gene_matches],
                                      orfsY$orf_sequence[id_matches]))

        orfSimilarity.bygene <- data.frame(gene_id=orfsX$gene_id[gene_matches],
                                            spliced_id=orfsY$spliced_id[id_matches], similarity=x.bygene,
                                            length_x=orfsX$orf_length[gene_matches], length_y=orfsY$orf_length[id_matches])


        orfLengthKept <- orfSimilarity.bygene$similarity * orfSimilarity.bygene$length_x
        orfSimilarity.bygene$orf_percent_new <- 1 - orfLengthKept / orfSimilarity.bygene$length_y

        orfSimilarity.bygeneAgg <- aggregate(similarity ~ spliced_id, orfSimilarity.bygene, max)
        m <- match(orfChanges$id, orfSimilarity.bygeneAgg$spliced_id)
        orfChanges$max_orf_kept_bygene <- orfSimilarity.bygeneAgg$similarity[m]

        orfNew.bygeneAgg <- aggregate(orf_percent_new ~ spliced_id, orfSimilarity.bygene, min)
        m <- match(orfChanges$id, orfNew.bygeneAgg$spliced_id)
        orfChanges$new_orfBygene <- orfNew.bygeneAgg$orf_percent_new[m]

    }

    orfChanges$transcript_id <- NULL
    orfChanges$gene_id <- NULL
    orfChanges$id_orf_length_x <- NULL
    orfChanges$id_orf_length_y <- NULL

    return(orfChanges)
}

#' Evaluate the change in an attribute between a set of 'normal' transcripts and 'alternative' transcripts
#' @param orfsX orf information for 'normal' transcripts. Generated by getOrfs()
#' @param orfsY orf information for 'alternative' transcripts. Generated by getOrfs()
#' @param attribute attribute to compare
#' @param compareBy compare by 'transcript' isoforms or by 'gene' groups
#' @param useMax use max as the summary function when multiple isoforms are aggregated? If FALSE, will use min instead.
#' @return data.frame with attribute changes
#' @export
#' @import stringr
#' @examples
#' @author Beth Signal
attrChangeAltSpliced <- function(orfsX,
                                 orfsY,
                                 attribute = "orf_length",
                                 compareBy = "gene",
                                 useMax = TRUE,
                                 compareUTR = FALSE){

    if(nrow(orfsX) > 0 & nrow(orfsY) > 0){

        if(useMax){
            aggFun <- max
        }else{
            aggFun <- min
        }



        m <- match(c('id','gene_id', attribute), colnames(orfsX))

        orfsX.part <- orfsX[,m]

        attributeX <- aggregate(. ~ id+gene_id, orfsX.part, aggFun)

        if(all(grepl("AS", attributeX$id))){
            attributeX$as_group <- unlist(lapply(str_split(attributeX$id, " "), '[[', 2))
            attributeX$transcript_id <- unlist(lapply(str_split(attributeX$id, "[+]"), '[[', 1))
        }

        m <- match(c('id','gene_id', attribute), colnames(orfsY))
        orfsY.part <- orfsY[,m]
        attributeY <- aggregate(. ~ id+gene_id, orfsY.part, aggFun)

        if(all(grepl("AS", attributeY$id))){
            attributeY$as_group <- unlist(lapply(str_split(attributeY$id, " "), '[[', 2))
            attributeY$transcript_id <- unlist(lapply(str_split(attributeY$id, "[+]"), '[[', 1))
        }


        if(all(colnames(attributeX) != "as_group")){
            m <- match(attributeY$transcript_id, attributeX$id)
            attributeX <- attributeX[m,]
            attributeX$as_group <- attributeY$as_group
            attributeX$id <- attributeY$id
        }else if(all(colnames(attributeY) != "as_group")){
            m <- match(attributeX$transcript_id, attributeY$id)
            attributeY <- attributeY[m,]
            attributeY$as_group <- attributeX$as_group
            attributeY$id <- attributeX$id
        }

        colnames(attributeX)[3] <- "attr"
        colnames(attributeY)[3] <- "attr"

        if(compareBy == "transcript"){
            m <- match(attributeX$id, attributeY$id)
            attributeComparisons <- data.frame(id=attributeX$id,
                                     attr_bygroup_x=attributeX$attr,
                                     attr_bygroup_y=attributeY$attr[m])

            m <- match(attributeY$id, attributeX$id)
            attributeComparisonsY <- data.frame(id=attributeY$id,
                                       attr_bygroup_x=attributeX$attr[m],
                                       attr_bygroup_y=attributeY$attr)

            add <- which(!(attributeComparisonsY$id %in% attributeComparisons$id))

            if(length(add) > 0){
                attributeComparisons <- rbind(attributeComparisons, attributeComparisonsY[add,])
            }
        }else if(compareBy=="gene"){
            attributeX2 <- aggregate(attr ~ as_group, attributeX, aggFun)
            attributeY2 <- aggregate(attr ~ as_group, attributeY, aggFun)

            m <- match(attributeX2$as_group, attributeY2$as_group)
            attributeComparisons <- data.frame(id=attributeX2[,1],
                                     attr_bygroup_x=attributeX2[,-1],
                                     attr_bygroup_y=attributeY2[m,-1])
            attributeComparisons <- attributeComparisons[which(!is.na(m)),]

        }
        colnames(attributeComparisons) <- gsub("attr", attribute, colnames(attributeComparisons))

        if(compareUTR == TRUE){
            if(all(grepl("AS", orfsX$id))){
                id_x <- paste0(attributeComparisons$id,"_" ,attributeComparisons$orf_length_bygroup_x)
                m1 <- match(id_x, paste0(unlist(lapply(str_split(orfsX$id, "AS "), "[[", 2)), "_", orfsX$orf_length))
            }else{
                m_toGene <- match(attributeComparisons$id, attributeX$as_group)
                id_x <- paste0(unlist(lapply(str_split(attributeX$id[m_toGene], "[+]"),"[[",1)),"_" ,attributeComparisons$orf_length_bygroup_x)
                m1 <- match(id_x, paste0((orfsX$id), "_", orfsX$orf_length))
            }
            id_y <- paste0(attributeComparisons$id,"_" ,attributeComparisons$orf_length_bygroup_y)
            m2 <- match(id_y, paste0(unlist(lapply(str_split(orfsY$id, "AS "), "[[", 2)), "_", orfsY$orf_length))

            attributeComparisons$utr3_length_bygroup_x <- orfsX$utr3_length[m1]
            attributeComparisons$utr3_length_bygroup_y <- orfsY$utr3_length[m2]
            attributeComparisons$utr5_length_bygroup_x <- orfsX$start_site_nt[m1]
            attributeComparisons$utr5_length_bygroup_y <- orfsY$start_site_nt[m2]
        }

        return(attributeComparisons)
    }else{
        blank <- data.frame(id=character(0),
                            attr_bygroup_x=numeric(0),
                            attr_bygroup_y=numeric(0))
        colnames(blank) <- gsub("attr", attribute, colnames(blank))
        if(compareUTR == TRUE){
            blank$utr3_length_bygroup_x <- numeric(0)
            blank$utr3_length_bygroup_y <- numeric(0)
            blank$utr5_length_bygroup_x <- numeric(0)
            blank$utr5_length_bygroup_y <- numeric(0)
        }
        return(blank)
    }
}
#' calculate percentage of orfB contained in orfA
#' @param orfA character string of ORF amino acid sequence
#' @param orfB character string of ORF amino acid sequence
#' @return percentage of orfB contained in orfA
#' @export
#' @import stringdist
#' @examples
#' @author Beth Signal
orfSimilarity <- function(orfA, orfB){
    ((nchar(orfA) + nchar(orfB) - stringdist::stringdist(orfA ,orfB, method = "lcs"))/2) / nchar(orfA)
}
